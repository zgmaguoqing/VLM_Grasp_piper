FROM nvidia/cuda:12.8.0-cudnn-devel-ubuntu22.04

ENV DEBIAN_FRONTEND=noninteractive
ENV LANG=en_US.UTF-8
ENV LC_ALL=en_US.UTF-8
ENV http_proxy="http://10.5.20.132:18889"
ENV https_proxy="http://10.5.20.132:18889"

# 同时保留大写版本以实现最佳兼容性
ENV HTTP_PROXY="http://10.5.20.132:18889"
ENV HTTPS_PROXY="http://10.5.20.132:18889"
# 1. 配置清华源 & APT 极限容错 (内容保持不变，利用缓存)
RUN echo "deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy main restricted universe multiverse" > /etc/apt/sources.list && \
    echo "deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy-updates main restricted universe multiverse" >> /etc/apt/sources.list && \
    echo "deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy-backports main restricted universe multiverse" >> /etc/apt/sources.list && \
    echo "deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy-security main restricted universe multiverse" >> /etc/apt/sources.list

RUN echo 'Acquire::Retries "100";' > /etc/apt/apt.conf.d/80-retries && \
    echo 'Acquire::http::Timeout "300";' >> /etc/apt/apt.conf.d/80-retries && \
    echo 'Acquire::https::Timeout "300";' >> /etc/apt/apt.conf.d/80-retries

# 2. 基础工具 (内容保持不变，利用缓存)
RUN apt-get update 
RUN apt-get install -y --no-install-recommends \
    curl \
    gnupg2 \
    lsb-release \
    software-properties-common \
    ca-certificates \
    locales \
    git \
    vim \
    net-tools \
    && locale-gen en_US en_US.UTF-8 \
    && update-locale LC_ALL=en_US.UTF-8 LANG=en_US.UTF-8

# 3. 添加 ROS 源 & 构建工具 (内容保持不变，利用缓存)
RUN curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key -o /usr/share/keyrings/ros-archive-keyring.gpg || \
    curl -sSL https://mirrors.tuna.tsinghua.edu.cn/rosdistro/ros.key -o /usr/share/keyrings/ros-archive-keyring.gpg

RUN echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] https://mirrors.tuna.tsinghua.edu.cn/ros2/ubuntu $(lsb_release -cs) main" | tee /etc/apt/sources.list.d/ros2.list > /dev/null

RUN apt-get update && apt-get install -y --no-install-recommends \
    python3-pip \
    python3-colcon-common-extensions \
    libboost-program-options-dev

# 4. 切片安装依赖 (内容保持不变，利用缓存)
RUN apt-get install -y --no-install-recommends --fix-missing \
    ros-humble-ros-core \
    ros-humble-ros-base

RUN apt-get install -y --no-install-recommends --fix-missing \
    libxinerama1 \
    libgtk-3-0 

RUN apt-get install -y --no-install-recommends --fix-missing \
    libopencv-core4.5d 

RUN apt-get install -y --no-install-recommends --fix-missing \
    libopencv-imgcodecs4.5d 

RUN apt-get install -y --no-install-recommends --fix-missing \
    libopencv-dev 

RUN apt-get install -y --no-install-recommends --fix-missing \
    python3-opencv

RUN apt-get install -y --no-install-recommends --fix-missing \
    libgazebo11 \
    libgazebo-dev \
    gazebo 

RUN apt-get install -y --no-install-recommends --fix-missing \
    ros-humble-gazebo-ros-pkgs \
    ros-humble-gazebo-ros2-control

RUN apt-get install -y --no-install-recommends --fix-missing \
    ros-humble-desktop 

RUN apt-get install -y --no-install-recommends --fix-missing \
    ros-humble-xacro 
    
RUN apt-get install -y --no-install-recommends --fix-missing \
    ros-humble-moveit 

RUN apt-get install -y --no-install-recommends --fix-missing \
    mesa-utils \
    libgl1-mesa-glx

RUN apt-get install -y \
    ros-humble-ros2-control\
    ros-humble-ros2-controllers\
    ros-humble-controller-manager

# 5. 项目构建 (Git Clone 等步骤保持不变，利用缓存)
RUN rosdep init && rosdep update || echo "rosdep failed but continuing"

WORKDIR /root/ros2_ws/src

RUN git clone https://github.com/agilexrobotics/piper_ros2.git || \
    git clone -b humble https://github.com/agilexrobotics/piper_ros.git




WORKDIR /root/ros2_ws

# =========================================================
# 【这里是关键补丁】
# 之前报错是因为没有 rosdep 命令。
# 我们在这里插入一个新层，专门安装 python3-rosdep 和 rosdepc
# 因为这行是在最后，前面的几百 MB 下载都不会受影响，直接 Cache 命中。
# =========================================================
RUN apt-get update && apt-get install -y python3-rosdep && \
    pip3 install -i https://pypi.tuna.tsinghua.edu.cn/simple rosdepc && \
    rosdepc init && \
    rosdepc update

# 【修改】使用 rosdepc install 替代 rosdep install
# rosdepc 是国内特供版，不会因为连接 github 失败而报错
RUN /bin/bash -c "source /opt/ros/humble/setup.bash && \
    rosdepc install --from-paths src --ignore-src -r -y"

# 修复 Gazebo 插件问题
# 1. 强制清理 empty.world 中的插件配置（防止之前的错误修改残留或被缓存）
RUN sed -i '/gazebo_ros_factory/d' /usr/share/gazebo-11/worlds/empty.world

# 2. 使用 sed 修改 launch 文件，添加 libgazebo_ros_factory.so 插件
RUN sed -i "s/'-s', 'libgazebo_ros_init.so'/'-s', 'libgazebo_ros_init.so', '-s', 'libgazebo_ros_factory.so'/g" /root/ros2_ws/src/piper_ros/src/piper_sim/piper_gazebo/launch/piper_with_gripper/piper_gazebo.launch.py

# 构建所有包
RUN /bin/bash -c "source /opt/ros/humble/setup.bash && \
    colcon build --symlink-install --parallel-workers 1"

# 6. 环境配置（不依赖项目代码）
RUN echo "source /opt/ros/humble/setup.bash" >> ~/.bashrc
RUN echo "source /root/ros2_ws/install/setup.bash" >> ~/.bashrc
RUN echo "export GAZEBO_MODEL_PATH=\$GAZEBO_MODEL_PATH:/root/ros2_ws/src/piper_ros2:/root/ros2_ws/src/piper_ros/src" >> ~/.bashrc

# 容器内增量部署（不依赖项目代码）


# 修复 joint8_ctrl.py 执行权限
RUN chmod +x /root/ros2_ws/install/piper_gazebo/lib/piper_gazebo/joint8_ctrl.py







# 7. 复制项目代码（放在最后，最大化缓存利用）
# 安装通用 Python 依赖（不依赖项目代码）
RUN pip3 install -i https://pypi.tuna.tsinghua.edu.cn/simple transforms3d




RUN pip3 install -i https://pypi.tuna.tsinghua.edu.cn/simple \
    "numpy==1.26.4" \
    scikit-learn \
    scipy \
    tqdm \
    pyyaml \
    ply

# PyTorch (CUDA 12.8 compatible)
RUN pip3 install -i https://pypi.tuna.tsinghua.edu.cn/simple \
    "torch==2.7.0" \
    torchvision \
    torchaudio

# Robotics & Simulation (Note relaxed versions for toolbox)
RUN pip3 install -i https://pypi.tuna.tsinghua.edu.cn/simple \
    "spatialmath-python>=1.1.14" \
    "roboticstoolbox-python>=1.1.0" \
    "modern-robotics==1.1.1" \
    "mujoco==3.3.1" \
    transforms3d \
    ikpy

# Vision & GraspNet
# 在安装 graspnetAPI 前设置环境变量
ENV SKLEARN_ALLOW_DEPRECATED_SKLEARN_PACKAGE_INSTALL=True
RUN pip3 install -i https://pypi.tuna.tsinghua.edu.cn/simple \
    "numpy==1.26.4" \
    "opencv-python>=4.6.0" \
    "ultralytics>=8.3.98" \
    open3d \
    graspnetAPI

# Audio & VLM
RUN pip3 install -i https://pypi.tuna.tsinghua.edu.cn/simple \
    "numpy==1.26.4" \
    openai-whisper \
    soundfile \
    sounddevice \
    pydub \
    openai

RUN pip3 install -i https://pypi.tuna.tsinghua.edu.cn/simple \
    "matplotlib>=3.5.0" 

# 在之前的 apt install 块中，或者单独添加一行
RUN apt-get install -y --no-install-recommends --fix-missing \
    libportaudio2 \
    libasound-dev
    
RUN pip3 install -i https://pypi.tuna.tsinghua.edu.cn/simple \
    "transforms3d>=0.4.1"

# 8. 复制 URDF 文件到指定位置 (如果存在)
# 注意：这里假设你本地目录已经有了 piper_ros.urdf
COPY piper_ros.urdf /root/piper_ws/piper_ros.urdf


    
WORKDIR /root/VLM_Grasp_Interactive
COPY ./graspnet-baseline /root/VLM_Grasp_Interactive/graspnet-baseline

# # 安装项目特定的 Python 依赖（需要 requirements.txt）
# RUN pip3 install -i https://pypi.tuna.tsinghua.edu.cn/simple -r requirements.txt 


# Compile PointNet++ and KNN CUDA extensions (Requires PyTorch & NVCC)
WORKDIR /root/VLM_Grasp_Interactive/graspnet-baseline/pointnet2
RUN python3 setup.py install

WORKDIR /root/VLM_Grasp_Interactive/graspnet-baseline/knn
RUN python3 setup.py install

WORKDIR /root/VLM_Grasp_Interactive




ENTRYPOINT ["/bin/bash"]